package com.example.furnizone

import android.os.Bundle
import androidx.activity.enableEdgeToEdge
import androidx.appcompat.app.AppCompatActivity
import androidx.core.view.ViewCompat
import androidx.core.view.WindowInsetsCompat
import android.content.Intent
import android.content.SharedPreferences
import android.view.View
import android.widget.*
import androidx.appcompat.widget.Toolbar
import androidx.recyclerview.widget.LinearLayoutManager
import androidx.recyclerview.widget.RecyclerView
import com.example.furnizone.adapter.CartAdapter
import com.example.furnizone.api.CouponApi
import com.example.furnizone.model.CouponOutputModel
import com.example.furnizone.model.OrderModel
import com.example.furnizone.model.OrderOutputModel
import com.example.furnizone.util.ConstantData
import com.google.android.material.bottomsheet.BottomSheetDialog
import com.razorpay.Checkout
import com.razorpay.PaymentResultListener
import org.json.JSONException
import org.json.JSONObject
import kotlin.math.floor
import kotlin.math.round

class CartActivity : AppCompatActivity() {
    private lateinit var prodTotalAmount: TextView
    private lateinit var prodGst: TextView
    private lateinit var prodAmount: TextView
    private lateinit var back: TextView
    private lateinit var tvCoupon: TextView
    private lateinit var rcylCart: RecyclerView
    private lateinit var radioCOD: RadioButton
    private lateinit var radioOnline: RadioButton
    private lateinit var btnConfirm: Button
    private lateinit var btnContinue: Button
    private lateinit var btnApply: Button
    private lateinit var btnShop: Button
    private lateinit var etCode: EditText
    private lateinit var llytCart: ScrollView
    private lateinit var empty: LinearLayout
    private lateinit var toolbar: Toolbar
    private lateinit var bottomSheetDialog: BottomSheetDialog
    private lateinit var address1: EditText
    private lateinit var address2: EditText
    private lateinit var pincode: EditText
    private var uid: String = "0"
    private var total = 0.0
    private var amt = 0.0
    private var tot = 0.0
    private var address: String? = null


    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        enableEdgeToEdge()
        setContentView(R.layout.activity_cart)
        ViewCompat.setOnApplyWindowInsetsListener(findViewById(R.id.main)) { v, insets ->
            val systemBars = insets.getInsets(WindowInsetsCompat.Type.systemBars())
            v.setPadding(systemBars.left, systemBars.top, systemBars.right, systemBars.bottom)
            insets
        }

        // Initialize views
        prodTotalAmount = findViewById(R.id.prod_total_amount)
        prodGst = findViewById(R.id.prod_gst)
        prodAmount = findViewById(R.id.prod_amount)
        rcylCart = findViewById(R.id.rcyl_cart)
        radioCOD = findViewById(R.id.RadioCOD)
        radioOnline = findViewById(R.id.RadioOnline)
        btnContinue = findViewById(R.id.btnContinue)
        etCode = findViewById(R.id.etcode)
        btnApply = findViewById(R.id.btnApply)
        tvCoupon = findViewById(R.id.tvcopoun)
        llytCart = findViewById(R.id.llytCart)
        empty = findViewById(R.id.empty)
        btnShop = findViewById(R.id.btnshop)
//        toolbar = findViewById(R.id.toolbar)
        back = findViewById(R.id.back)

//        // Toolbar back
//        toolbar.setNavigationOnClickListener {
//            startActivity(Intent(this, HomeActivity::class.java))
//        }

        btnShop.setOnClickListener {
            startActivity(Intent(this, HomeActivity::class.java))
        }
        // Coupon apply
        btnApply.setOnClickListener {
            val ccode = etCode.text.toString()
            if (ccode.trim().isEmpty()) {
                tvCoupon.text = "0%"
                Toast.makeText(this, "Please Enter Code", Toast.LENGTH_SHORT).show()
            } else {
                CouponApi().getCouponDiscount(this, ccode)
            }
        }

        // SharedPreferences
        val sp: SharedPreferences = getSharedPreferences(ConstantData.SP_LOGIN_PREFS, MODE_PRIVATE)
        uid = sp.getString(ConstantData.KEY_ID, "0") ?: "0"

//        openDialog()

        btnContinue.setOnClickListener {
            bottomSheetDialog.show()
        }

//        getCartData()

        back.setOnClickListener {
            startActivity(Intent(this, HomeActivity::class.java))
        }

    }
/*
    fun calculateAmount(couponOutputModel: CouponOutputModel) {
        if (!couponOutputModel.coupen.isNullOrEmpty()) {
            val discount = couponOutputModel.coupen!![0].coupen_discount?.toDoubleOrNull() ?: 0.0
            tvCoupon.text = "${discount.roundToInt()}%"
            val calc = tot * (discount / 100)
            val finalAmt = tot - calc
            prodTotalAmount.text = floor(finalAmt).toString()
        }
    }

    private fun Double.roundToInt(): Int = round(this).toInt()

    fun openDialog() {
        bottomSheetDialog = BottomSheetDialog(this)
        val bottomSheet = layoutInflater.inflate(R.layout.layout_address, null)

        address1 = bottomSheet.findViewById(R.id.etAddress1)
        address2 = bottomSheet.findViewById(R.id.etAddress2)
        pincode = bottomSheet.findViewById(R.id.pincode)
        btnConfirm = bottomSheet.findViewById(R.id.btnConfirm)

        btnConfirm.setOnClickListener {
            val ad1 = address1.text.toString()
            val ad2 = address2.text.toString()
            val pin = pincode.text.toString()

            when {
                ad1.trim().isEmpty() -> Toast.makeText(this, "Please enter Address 1", Toast.LENGTH_SHORT).show()
                ad2.trim().isEmpty() -> Toast.makeText(this, "Please enter Address 2", Toast.LENGTH_SHORT).show()
                pin.trim().isEmpty() -> Toast.makeText(this, "Please enter Pincode", Toast.LENGTH_SHORT).show()
                else -> {
                    address = ad1 + ad2 + pin
                    if (radioCOD.isChecked) {
                        OrderApi().confirmOrder(uid, address ?: "", "1", this)
                    } else {
                        makePayment()
                    }
                }
            }
        }
        bottomSheetDialog.setContentView(bottomSheet)
    }

    fun setCart(orderOutputModel: OrderOutputModel) {
        if (orderOutputModel.order.isNullOrEmpty()) {
            llytCart.visibility = View.GONE
            empty.visibility = View.VISIBLE
        } else {
            llytCart.visibility = View.VISIBLE
            empty.visibility = View.GONE

            amt = 0.0
            tot = 0.0
            for (order in orderOutputModel.order!!) {
                amt += order.totalAmount?.toDoubleOrNull() ?: 0.0
                tot = amt + (amt * 0.18)
            }

            prodAmount.text = amt.toString()
            prodGst.text = floor(amt * 0.18).toString()
            prodTotalAmount.text = floor(tot).toString()
/*
            val cartAdapter = CartAdapter(orderOutputModel.order!!, object : CartAdapter.OnClickListener {
                override fun onClickPlus(om: OrderModel) {
                    OrderApi().updateOrder(om.id ?: "", om.quantity ?: "", om.amount ?: "", this@CartActivity)
                }

                override fun onClickMinus(om: OrderModel) {
                    OrderApi().updateOrder(om.id ?: "", om.quantity ?: "", om.amount ?: "", this@CartActivity)
                }

                override fun removeClick(om: OrderModel) {
                    OrderApi().removeOrder(om.id ?: "", this@CartActivity)
                }
            }, this)

            rcylCart.layoutManager = LinearLayoutManager(this)
            rcylCart.adapter = cartAdapter*/
        }
    }

    fun getCartData() {
        if (uid != "0") {
            OrderApi().getOrderPending(uid, this)
        }
    }
/*
    override fun onPaymentSuccess(p0: String?) {
        OrderApi().confirmOrder(uid, address ?: "", "2", this)
    }

    override fun onPaymentError(p0: Int, p1: String?) {
        Toast.makeText(this, "Payment error", Toast.LENGTH_SHORT).show()
    }
*/
    fun makePayment() {
        val amount = (tot * 100).toFloat().toInt()

        val checkout = Checkout()
        checkout.setKeyID("rzp_test_NE1WFCw0DgsblV")
        checkout.setImage(R.mipmap.logo1)

        val obj = JSONObject()
        try {
            obj.put("name", "FURNIZONE")
            obj.put("description", "Test payment")
            obj.put("theme.color", "")
            obj.put("currency", "INR")
            obj.put("amount", amount)
            obj.put("prefill.contact", "9157140988")
            obj.put("prefill.email", "sahildharani890@gmail.com")
            checkout.open(this, obj)
        } catch (e: JSONException) {
            e.printStackTrace()
        }
    }

    fun done() {
        startActivity(Intent(this, HurrayActivity::class.java))
    }
*/
}